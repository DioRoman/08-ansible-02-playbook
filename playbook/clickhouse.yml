---
- name: Install Latest ClickHouse
  hosts: clickhouse
  become: true
  tasks:

    - name: Install required packages
      apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg
        state: present
        update_cache: false

    - name: Ensure GPG directory exists
      ansible.builtin.file:
        path: /usr/share/keyrings
        state: directory
        mode: 0755

    - name: Download and import ClickHouse GPG key
      ansible.builtin.shell: |
        curl -fsSL 'https://packages.clickhouse.com/rpm/lts/repodata/repomd.xml.key' | gpg --dearmor -o /usr/share/keyrings/clickhouse-keyring.gpg
      args:
        creates: /usr/share/keyrings/clickhouse-keyring.gpg
      register: key_import
      changed_when: "'gpg: keyring' in key_import.stderr"

    - name: Verify GPG key permissions
      ansible.builtin.file:
        path: /usr/share/keyrings/clickhouse-keyring.gpg
        mode: 0644

    - name: Ensure directory exists
      file:
        path: /etc/apt/sources.list.d
        state: directory
        mode: 0755

    - name: Add repository using tee (exact command reproduction)
      shell:
        sudo echo "deb [signed-by=/usr/share/keyrings/clickhouse-keyring.gpg arch=amd64] https://packages.clickhouse.com/deb lts main" | sudo tee /etc/apt/sources.list.d/clickhouse.list
      args:
        creates: /etc/apt/sources.list.d/clickhouse.list

    - name: Run apt-get update via command
      shell:
       sudo apt-get update -y
      register: apt_update

    - name: Пауза на 30 секунд
      pause:
        seconds: 30

    - name: Install specific ClickHouse packages
      apt:
        name:
          - "clickhouse-server={{ clickhouse_version }}"
          - "clickhouse-client={{ clickhouse_version }}"
          - "clickhouse-common-static={{ clickhouse_version }}"
        state: present
        allow_downgrade: true
        force_apt_get: true

    - name: Ensure ClickHouse service is running and enabled
      service:
        name: clickhouse-server
        state: started
        enabled: true

    - name: Get ClickHouse version
      command: clickhouse-client --query "SELECT version()"
      register: ch_version
      changed_when: false

    - name: Show installed version
      debug:
        msg: "Установлена версия ClickHouse: {{ ch_version.stdout }}"

    - name: Create database
      ansible.builtin.command: "clickhouse-client -q 'create database logs;'"
      register: create_db
      failed_when: create_db.rc != 0 and create_db.rc != 82
      changed_when: create_db.rc == 0